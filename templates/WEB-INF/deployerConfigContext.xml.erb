<?xml version="1.0" encoding="UTF-8"?>
<!--
	| deployerConfigContext.xml centralizes into one file some of the declarative configuration that
	| all CAS deployers will need to modify.
	|
	| This file declares some of the Spring-managed JavaBeans that make up a CAS deployment.  
	| The beans declared in this file are instantiated at context initialization time by the Spring 
	| ContextLoaderListener declared in web.xml.  It finds this file because this
	| file is among those declared in the context parameter "contextConfigLocation".
	|
	| By far the most common change you will need to make in this file is to change the last bean
	| declaration to replace the default SimpleTestUsernamePasswordAuthenticationHandler with
	| one implementing your approach for authenticating usernames and passwords.
	+-->
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:sec="http://www.springframework.org/schema/security"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.0.xsd">
  
  <!-- 
  ============================================
	        LDAP Config - Context Source
  ============================================
  -->
  <bean id="contextSource" class="org.springframework.ldap.core.support.LdapContextSource">
  
    <property name="pooled" value="false"/>

    <property name="url" value="<%= ldap_server %>" />

    <property name="userDn" value="CN=<%= ldap_userDN %>"/>
    <property name="password" value="<%= ldap_password %>"/>
    
    <!-- Place JNDI environment properties here. -->
    <property name="baseEnvironmentProperties">
      <map>
        <entry key="com.sun.jndi.ldap.connect.timeout" value="2000" />
        <entry key="com.sun.jndi.ldap.read.timeout" value="2000" />
        <entry key="java.naming.security.authentication" value="simple" /><!-- Explained at http://download.oracle.com/javase/1.3/docs/api/javax/naming/Context.html#SECURITY_AUTHENTICATION -->
      </map>
    </property>
  </bean>
  
  
  <!-- 
  ============================================
	        authenticationManager
  ============================================
  -->
  
	<bean id="authenticationManager" class="org.jasig.cas.authentication.AuthenticationManagerImpl">
    
    <property name="credentialsToPrincipalResolvers">
      <list>
        
        <bean class="org.jasig.cas.authentication.principal.CredentialsToLDAPAttributePrincipalResolver">
          <property name="credentialsToPrincipalResolver">
            <bean class="org.jasig.cas.authentication.principal.UsernamePasswordCredentialsToPrincipalResolver"/>
          </property>
          <property name="filter" value="sAMAccountName=%u"/>
          <property name="principalAttributeName" value="sAMAccountName"/>
          <property name="searchBase" value="dc=arcadia,dc=edu"/>
          <property name="contextSource" ref="contextSource"/>
          <property name="attributeRepository">
            <ref bean="attributeRepository"/>
          </property>
        </bean>
        
      </list>
   </property>

		<property name="authenticationHandlers">
			<list>
				<bean class="org.jasig.cas.authentication.handler.support.HttpBasedServiceCredentialsAuthenticationHandler"
					p:httpClient-ref="httpClient" />
				
				<bean class="org.jasig.cas.adaptors.ldap.BindLdapAuthenticationHandler">
            <property name="filter" value="sAMAccountName=%u" />
            <property name="searchBase" value="dc=arcadia,dc=edu"/>
            <property name="ignorePartialResultException" value="yes" />
            <property name="contextSource" ref="contextSource" />
        </bean>	
				
			</list>
		</property>
		
	</bean>
    
  

	<!--
	This bean defines the security roles for the Services Management application.  Simple deployments can use the in-memory version.
	More robust deployments will want to use another option, such as the Jdbc version.
	
	The name of this should remain "userDetailsService" in order for Spring Security to find it.
	 -->
    <!-- <sec:user name="@@THIS SHOULD BE REPLACED@@" password="notused" authorities="ROLE_ADMIN" />-->

    <sec:user-service id="userDetailsService">
        <sec:user name="arcadiaadmin" password="notused" authorities="ROLE_ADMIN" />
    </sec:user-service>
  
	<bean id="attributeRepository" class="org.jasig.services.persondir.support.ldap.LdapPersonAttributeDao">
    <property name="baseDN" value="dc=arcadia,dc=edu" />
    <property name="contextSource" ref="contextSource" />
    <property name="requireAllQueryAttributes" value="true" />
    <property name="queryAttributeMapping">
      <map>
        <entry key="screenname" value="uid" />
        <entry key="uid" value="uid" />
        <entry key="displayName" value="displayName" />
        <entry key="sn" value="sn" />
      </map>
    </property>
    <property name="resultAttributeMapping">
      <map>
        <entry key="mail" value="EmailAddress" />
        <entry key="givenName" value="givenName"/>
        <entry key="distinguishedName" value="distinguishedName" />
        <entry key="sn" value="sn" />
        <entry key="uid" value="uid" />
        <entry key="displayName" value="displayName" />
      </map>
    </property>
  </bean>
	
	<!-- 
	Sample, in-memory data store for the ServiceRegistry. A real implementation
	would probably want to replace this with the JPA-backed ServiceRegistry DAO
	The name of this bean should remain "serviceRegistryDao".
	 -->
	<bean
		id="serviceRegistryDao"
        class="org.jasig.cas.services.InMemoryServiceRegistryDaoImpl">
            <property name="registeredServices">
                <list>
                    <bean class="org.jasig.cas.services.RegisteredServiceImpl">
                        <property name="id" value="0" />
                        <property name="name" value="HTTP" />
                        <property name="description" value="Only Allows HTTP Urls" />
                        <property name="serviceId" value="http://**" />
                        <property name="allowedAttributes">
                          <list>
                                <value>cn</value>
                                <value>name</value>
                                <value>givenName</value>
                                <value>displayName</value>
                                <value>userPrincipalName</value>
                                <value>sAMAAccountName</value>
                                <value>telephone</value>
                                <value>mail</value>
                                <value>memberOf</value>
                          </list>
                        </property>
                    </bean>

                    <bean class="org.jasig.cas.services.RegisteredServiceImpl">
                        <property name="id" value="1" />
                        <property name="name" value="HTTPS" />
                        <property name="description" value="Only Allows HTTPS Urls" />
                        <property name="serviceId" value="https://**" />
                    </bean>

                    <bean class="org.jasig.cas.services.RegisteredServiceImpl">
                        <property name="id" value="2" />
                        <property name="name" value="IMAPS" />
                        <property name="description" value="Only Allows HTTPS Urls" />
                        <property name="serviceId" value="imaps://**" />
                    </bean>

                    <bean class="org.jasig.cas.services.RegisteredServiceImpl">
                        <property name="id" value="3" />
                        <property name="name" value="IMAP" />
                        <property name="description" value="Only Allows IMAP Urls" />
                        <property name="serviceId" value="imap://**" />
                    </bean>
                </list>
            </property>
        </bean>

    <bean id="auditTrailManager" class="com.github.inspektr.audit.support.Slf4jLoggingAuditTrailManager" />
</beans>